# üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π

## –û–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞

–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   User      ‚îÇ
‚îÇ (Telegram/  ‚îÇ
‚îÇ   API)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 1. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ + –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     Adapter Layer                  ‚îÇ
‚îÇ  ‚Ä¢ webhook.py / handlers.py        ‚îÇ
‚îÇ  ‚Ä¢ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 2. –í—ã–∑–æ–≤ —Å–µ—Ä–≤–∏—Å–∞
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PhotoAnalysisService             ‚îÇ
‚îÇ                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç       ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤       ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 3. –°–æ–∑–¥–∞–Ω–∏–µ PhotoAnalysis    ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ           ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 5. ML-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è          ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ 6. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ 7. –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Response                         ‚îÇ
‚îÇ  ‚Ä¢ analysis_id                     ‚îÇ
‚îÇ  ‚Ä¢ dominant_waste_type             ‚îÇ
‚îÇ  ‚Ä¢ detections                      ‚îÇ
‚îÇ  ‚Ä¢ photo_url                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —à–∞–≥–æ–≤

### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏**:
- **Telegram Bot** - `handlers.py`
- **Webhook API** - `webhook.py`

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**:
```python
photo_data: bytes      # –ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ
latitude: float        # -90 –¥–æ 90
longitude: float       # -180 –¥–æ 180
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –∞–¥–∞–ø—Ç–µ—Ä–∞**:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–æ—Ç–æ (JPEG/PNG)
- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å. 10 MB)
- –ù–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π

### –®–∞–≥ 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

**–ö–ª–∞—Å—Å**: `Location` (domain/models.py)

```python
def __post_init__(self) -> None:
    if not -90 <= self.latitude <= 90:
        raise ValueError(f"Invalid latitude: {self.latitude}")
    if not -180 <= self.longitude <= 180:
        raise ValueError(f"Invalid longitude: {self.longitude}")
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è**:
- ‚úÖ –®–∏—Ä–æ—Ç–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö [-90, 90]
- ‚úÖ –î–æ–ª–≥–æ—Ç–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö [-180, 180]
- ‚ùå –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–∫–µ–∞–Ω)

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è**:
- `InvalidLocationError` - –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–ú–µ—Ç–æ–¥**: `location_already_analyzed()` (IAnalysisRepository)

**–ê–ª–≥–æ—Ä–∏—Ç–º**:
```python
1. –ù–∞–π—Ç–∏ –≤—Å–µ –∞–Ω–∞–ª–∏–∑—ã –≤ —Ä–∞–¥–∏—É—Å–µ threshold_meters (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50–º)
2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ‚Üí –¥—É–±–ª–∏–∫–∞—Ç
3. –í–µ—Ä–Ω—É—Ç—å True/False
```

**–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è** (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è):
```python
lat_diff = abs(lat1 - lat2)
lon_diff = abs(lon1 - lon2)
distance_meters = sqrt(lat_diff¬≤ + lon_diff¬≤) * 111000
```

> üìù –í –ø—Ä–æ–¥–∞–∫—à–Ω–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PostGIS `ST_DWithin` –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è**:
- `DuplicateLocationError` - –º–µ—Å—Ç–æ —É–∂–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–æ—Å—å

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞**:
```env
DUPLICATE_CHECK_THRESHOLD_METERS=50.0  # –ü–æ—Ä–æ–≥ –≤ –º–µ—Ç—Ä–∞—Ö
```

**–ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏**:
```python
await service.process_photo(..., skip_duplicate_check=True)
```

### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞

**–ö–ª–∞—Å—Å**: `PhotoAnalysis` (domain/models.py)

```python
analysis = PhotoAnalysis.create(
    photo_url="",  # –ü–æ–∫–∞ –ø—É—Å—Ç–æ–π
    location=location,
)
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è:
# - id: UUID
# - status: PENDING
# - created_at: datetime.utcnow()
# - detections: []
```

**–°—Ç–∞—Ç—É—Å—ã –∞–Ω–∞–ª–∏–∑–∞**:
- `PENDING` - —Å–æ–∑–¥–∞–Ω, –∂–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `PROCESSING` - –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `COMPLETED` - —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω
- `FAILED` - –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ

### –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: `IPhotoStorage`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**: `StubPhotoStorage` (in-memory)

**–ë—É–¥—É—â–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**:
- `LocalPhotoStorage` - –ª–æ–∫–∞–ª—å–Ω–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
- `S3PhotoStorage` - Amazon S3 / MinIO

**–ü—Ä–æ—Ü–µ—Å—Å**:
```python
photo_url = await photo_storage.save_photo(
    photo_data=photo_data,
    photo_id=analysis.id,
)
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: "http://localhost:8000/photos/{uuid}.jpg"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**:
- –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
- URL –¥–æ–±–∞–≤–ª–µ–Ω –≤ `analysis.photo_url`

### –®–∞–≥ 6: ML-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: `IWasteClassifier`

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**: `StubWasteClassifier` (—Å–ª—É—á–∞–π–Ω—ã–µ –¥–µ—Ç–µ–∫—Ü–∏–∏)

**–ë—É–¥—É—â–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**:
- `YOLOv8Classifier` - YOLOv8 –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤
- `Detectron2Classifier` - Detectron2 –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
- `EnsembleClassifier` - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π

**–ü—Ä–æ—Ü–µ—Å—Å**:
```python
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–∏
if not await classifier.is_ready():
    raise MLModelError("Model not ready")

# 2. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
detections = await classifier.classify(photo_data)

# 3. –†–µ–∑—É–ª—å—Ç–∞—Ç
for detection in detections:
    print(f"{detection.waste_type}: {detection.confidence:.0%}")
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏**:
```python
@dataclass
class WasteDetection:
    waste_type: WasteType         # plastic, metal, paper, etc.
    confidence: float             # 0.0 –¥–æ 1.0
    bounding_box: tuple | None    # (x1, y1, x2, y2) –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
```

**–¢–∏–ø—ã –º—É—Å–æ—Ä–∞**:
- `PLASTIC` ü•§ - –ø–ª–∞—Å—Ç–∏–∫
- `METAL` üî© - –º–µ—Ç–∞–ª–ª
- `PAPER` üìÑ - –±—É–º–∞–≥–∞
- `GLASS` üçæ - —Å—Ç–µ–∫–ª–æ
- `ORGANIC` üçé - –æ—Ä–≥–∞–Ω–∏–∫–∞
- `TEXTILE` üëï - —Ç–µ–∫—Å—Ç–∏–ª—å
- `ELECTRONICS` üíª - —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞
- `MIXED` ‚ôªÔ∏è - —Å–º–µ—à–∞–Ω–Ω—ã–π
- `UNKNOWN` ‚ùì - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ

### –®–∞–≥ 7: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–≥–æ —Ç–∏–ø–∞

**–ú–µ—Ç–æ–¥**: `get_dominant_waste_type()`

```python
def get_dominant_waste_type(self) -> WasteType:
    if not self.detections:
        return WasteType.UNKNOWN
    
    # –ë–µ—Ä–µ–º –¥–µ—Ç–µ–∫—Ü–∏—é —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º confidence
    return max(self.detections, key=lambda d: d.confidence).waste_type
```

**–ü—Ä–∏–º–µ—Ä**:
```python
detections = [
    WasteDetection(waste_type="plastic", confidence=0.85),
    WasteDetection(waste_type="metal", confidence=0.65),
    WasteDetection(waste_type="paper", confidence=0.45),
]
# dominant_waste_type = "plastic"
```

### –®–∞–≥ 8: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: `IAnalysisRepository`

**–ü—Ä–æ—Ü–µ—Å—Å**:
```python
analysis.status = AnalysisStatus.COMPLETED
analysis.processed_at = datetime.utcnow()
await analysis_repo.save(analysis)
```

**–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**:
- ID –∞–Ω–∞–ª–∏–∑–∞
- –°—Ç–∞—Ç—É—Å (COMPLETED/FAILED)
- –§–æ—Ç–æ URL
- –õ–æ–∫–∞—Ü–∏—è (–∫–∞–∫ PostGIS POINT)
- –î–µ—Ç–µ–∫—Ü–∏–∏ (JSON)
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏

**–í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏**:
```python
except Exception as e:
    analysis.status = AnalysisStatus.FAILED
    analysis.error_message = str(e)
    await analysis_repo.save(analysis)
    raise
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### InvalidLocationError

**–ö–æ–≥–¥–∞**: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã

**–û—Ç–≤–µ—Ç API**:
```json
{
  "detail": "Invalid latitude: 100.0"
}
```

**HTTP –∫–æ–¥**: 400 Bad Request

### DuplicateLocationError

**–ö–æ–≥–¥–∞**: –ú–µ—Å—Ç–æ —É–∂–µ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–æ—Å—å (< 50 –º–µ—Ç—Ä–æ–≤)

**–û—Ç–≤–µ—Ç API**:
```json
{
  "detail": "Location (55.7558, 37.6173) was already analyzed"
}
```

**HTTP –∫–æ–¥**: 409 Conflict

### PhotoProcessingError

**–ö–æ–≥–¥–∞**: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ (ML –º–æ–¥–µ–ª—å, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)

**–û—Ç–≤–µ—Ç API**:
```json
{
  "detail": "Failed to process photo: ..."
}
```

**HTTP –∫–æ–¥**: 500 Internal Server Error

### MLModelError

**–ö–æ–≥–¥–∞**: ML –º–æ–¥–µ–ª—å –Ω–µ –≥–æ—Ç–æ–≤–∞ –∏–ª–∏ —É–ø–∞–ª–∞

**–õ–æ–≥–∏–∫–∞**: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º FAILED

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ:
```python
async def process_photo(...):
    await photo_storage.save_photo(...)
    await classifier.classify(...)
    await analysis_repo.save(...)
```

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**TODO**: –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö —Ñ–æ—Ç–æ
- Redis –¥–ª—è –∫–µ—à–∞
- Hash –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞–∫ –∫–ª—é—á
- TTL: 24 —á–∞—Å–∞

### –ë–∞—Ç—á–∏–Ω–≥

**TODO**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
```python
await asyncio.gather(*[
    classifier.classify(photo1),
    classifier.classify(photo2),
    classifier.classify(photo3),
])
```

## –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä—É—é—Ç—Å—è

- ‚úÖ –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
- ‚úÖ –û—à–∏–±–∫–∏ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ ID –∞–Ω–∞–ª–∏–∑–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –¢–∏–ø—ã –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –º—É—Å–æ—Ä–∞

### TODO: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- Prometheus –º–µ—Ç—Ä–∏–∫–∏
- Sentry –¥–ª—è –æ—à–∏–±–æ–∫
- Grafana –¥–∞—à–±–æ—Ä–¥—ã

## –°–º. —Ç–∞–∫–∂–µ

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](overview.md)
- [–°–µ—Ä–≤–∏—Å—ã](services.md)
- [ADR-003: Duplicate Detection](../adr/003-duplicate-detection.md)

