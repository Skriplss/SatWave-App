# ADR-004: Telegram Bot vs Web Application

## Status

**Accepted**

## Date

2024-11-08

## Context

Нужен способ для граждан и волонтеров отправлять фото мусора. Рассматривались варианты:
- Web приложение
- Мобильное приложение (iOS/Android)
- Telegram бот
- WhatsApp бот

### Требования

**Функциональные**:
- Отправка фото с телефона
- Отправка геолокации
- Получение результата анализа
- Простота использования

**Нефункциональные**:
- Быстрая разработка (MVP за 1-2 дня)
- Без регистрации
- Работает на любом телефоне
- Не требует установки приложения

## Рассмотренные альтернативы

### 1. Web Application (PWA)

**Плюсы**:
- ✅ Кросс-платформенность
- ✅ Не требует установки
- ✅ Легко обновлять

**Минусы**:
- ❌ Нужна разработка frontend (React/Vue)
- ❌ Сложность с доступом к камере и GPS на iOS
- ❌ Требуется дизайн и UX работа
- ❌ 1-2 недели разработки минимум

### 2. Native Mobile App (iOS + Android)

**Плюсы**:
- ✅ Лучший UX
- ✅ Полный контроль над UI/UX
- ✅ Нативный доступ к камере и GPS

**Минусы**:
- ❌ Долгая разработка (2-3 месяца)
- ❌ Нужны 2 команды (iOS + Android)
- ❌ App Store и Google Play review
- ❌ Требует установки
- ❌ Высокая стоимость разработки

### 3. Telegram Bot

**Плюсы**:
- ✅ Быстрая разработка (1-2 дня)
- ✅ Telegram уже установлен у многих
- ✅ Не требует регистрации (анонимно)
- ✅ Простой API (aiogram)
- ✅ Бесплатный hosting на Telegram
- ✅ Push-уведомления из коробки
- ✅ Легко отправлять фото и геолокацию

**Минусы**:
- ❌ Требует Telegram (но у большинства есть)
- ❌ Ограниченный UI (только текст, кнопки, inline)
- ❌ Зависимость от Telegram

### 4. WhatsApp Bot

**Плюсы**:
- ✅ Большая аудитория
- ✅ Похож на Telegram Bot

**Минусы**:
- ❌ WhatsApp Business API платный
- ❌ Сложнее настройка
- ❌ Ограничения на количество сообщений

## Decision

Использовать **Telegram Bot** как основной канал для граждан.

### Обоснование

1. **Speed to Market**
   - Разработка: 1-2 дня (vs недели для web/mobile)
   - Развертывание: instant (не нужен review)

2. **User Adoption**
   - Telegram популярен в целевой аудитории
   - Не требует установки нового приложения
   - Знакомый интерфейс

3. **Cost**
   - Бесплатно (vs $10K+ для mobile app)
   - Не нужен frontend разработчик

4. **Functionality**
   - Все что нужно: фото, геолокация, текст
   - Push-уведомления бесплатно

5. **Maintenance**
   - Легко обновлять (без app store)
   - Не нужно поддерживать 2 платформы

### Архитектура

```
Telegram User
    ↓ (отправляет фото + геолокацию)
Telegram Bot API
    ↓ (webhook или polling)
handlers.py (adapters/bot/)
    ↓ (вызывает)
PhotoAnalysisService (core/services/)
    ↓ (обрабатывает)
ML Model + Database
    ↓ (результат)
Telegram User
```

### Реализация

**Библиотека**: aiogram 3.x
- Современный async API
- Type hints
- Удобная работа с FSM (Finite State Machine)

**Deployment**:
- Polling для dev
- Webhook для production

**Features**:
- `/start` - приветствие
- `/help` - помощь
- Обработка фото
- Обработка геолокации
- Красивые ответы с эмодзи

## Consequences

### Положительные

1. **Быстрый MVP**
   - Разработка: 1-2 дня
   - Можем тестировать с реальными пользователями сразу

2. **Низкий порог входа**
   - Не нужно устанавливать приложение
   - Не нужна регистрация
   - Знакомый интерфейс

3. **Встроенные фичи**
   - Push-уведомления
   - Геолокация
   - Камера
   - Inline кнопки

4. **Легкая интеграция**
   - Тот же `PhotoAnalysisService`, что и для webhook API
   - Clean Architecture позволяет переиспользовать логику

5. **Аналитика**
   - Видим, кто использует (user_id)
   - Можем собирать статистику
   - A/B тесты через разные команды

### Отрицательные

1. **Зависимость от Telegram**
   - Если Telegram заблокируют - проблема
   - **Митигация**: параллельно webhook API

2. **Ограниченный UI**
   - Нельзя сделать красивую карту
   - Нельзя показать статистику в графиках
   - **Митигация**: для этого будет web-интерфейс

3. **Не все используют Telegram**
   - В некоторых странах популярнее WhatsApp
   - **Митигация**: webhook API доступен всем

4. **Сложно монетизировать**
   - Telegram не позволяет платежи в ботах (в некоторых регионах)
   - **Митигация**: не планируем брать деньги с граждан

### Нейтральные

1. **Анонимность** - пользователи не регистрируются (хорошо для privacy, плохо для аналитики)
2. **Telegram Premium features** - можем использовать, но не все пользователи имеют

## Roadmap

### Phase 1: MVP (✅ Done)
- [x] Базовый бот с `/start`, `/help`
- [x] Прием фото и геолокации
- [x] Интеграция с PhotoAnalysisService
- [x] Красивые ответы

### Phase 2: Improvements
- [ ] Inline кнопки для быстрых действий
- [ ] История анализов пользователя
- [ ] Статистика `/stats`
- [ ] Поделиться результатом

### Phase 3: Advanced
- [ ] Webhook вместо polling (prod)
- [ ] Redis для сессий (persistence)
- [ ] Rate limiting
- [ ] Admin-панель

### Phase 4: Multi-platform
- [ ] WhatsApp бот (если востребован)
- [ ] Web интерфейс для визуализации
- [ ] Mobile app (если бюджет)

## Интеграция с другими каналами

Telegram бот — один из способов отправки. Также есть:

1. **Webhook API** (для IoT-устройств, интеграций)
   ```python
   POST /webhook/photo
   ```

2. **Web App** (TODO)
   ```
   https://app.satwave.io
   ```

3. **Mobile App** (TODO)
   ```
   iOS + Android native
   ```

Все используют один и тот же `PhotoAnalysisService` благодаря Clean Architecture.

## Метрики успеха

**Adoption**:
- Количество пользователей ботаWeekly Active Users (WAU)
- Количество отправленных фото в день

**Engagement**:
- Retention (вернулись через неделю)
- Среднее количество фото на пользователя

**Quality**:
- Процент успешных анализов
- Время ответа

**Целевые значения (через 3 месяца)**:
- 1000+ пользователей
- 100+ фото в день
- 80%+ retention
- < 5 секунд время ответа

## Примеры использования

### Сценарий 1: Гражданин видит свалку

```
1. Открывает Telegram
2. Находит @satwave_bot
3. /start
4. Фотографирует мусор
5. Отправляет фото
6. Отправляет геолокацию
7. Получает: "✅ Пластик, 85% уверенности"
8. Доволен, закрывает
```

**Время**: 2-3 минуты

### Сценарий 2: Волонтер собирает данные

```
1. Обходит район
2. Находит 10 точек с мусором
3. Для каждой:
   - Фото + геолокация
   - Результат сохраняется
4. В конце дня: статистика
```

**Время**: 1-2 минуты на точку

### Сценарий 3: IoT-урна

```
1. Урна заполнена
2. Срабатывает датчик
3. Камера делает фото
4. API → Webhook
5. Результат → Dashboard
```

(Не через бота, через API, но та же логика)

## Альтернатива в будущем

Если Telegram не подойдет или понадобится больше функций:

**Progressive Web App (PWA)**:
```
Преимущества:
- Кросс-платформенность
- Работает offline
- Push-уведомления (на Android)
- Можно добавить на home screen

Недостатки:
- Нужна разработка frontend
- Сложнее с геолокацией на iOS
```

Но для MVP Telegram Bot — оптимальный выбор.

## References

- [Telegram Bot API](https://core.telegram.org/bots/api)
- [aiogram Documentation](https://docs.aiogram.dev/)
- [Telegram Bot Best Practices](https://core.telegram.org/bots/webapps#implementing-mini-apps)
- [ADR-001: Clean Architecture](001-clean-architecture.md) - позволяет легко добавлять новые каналы

